import React, { useState, useEffect } from 'react';
import { User, Send, FileText, CheckCircle, LogOut, Calendar, Sparkles, BookOpen, X, List, Lock, Clock, Wifi } from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "firebase/firestore";

// ------------------------------------------------------------------
// CONFIGURACI√ìN DE BASE DE DATOS
// ------------------------------------------------------------------

// 1. Configuraci√≥n Manual (IMPORTANTE: LLENAR ESTO EN GITHUB)
// Copia estos datos desde console.firebase.google.com -> Configuraci√≥n del proyecto -> Tus apps
const MANUAL_CONFIG = {
  apiKey: "TU_API_KEY_AQUI",            
  authDomain: "TU_PROYECTO.firebaseapp.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_PROYECTO.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};

// 2. L√≥gica de Selecci√≥n (No es necesario tocar esto)
// Esto permite que el c√≥digo funcione tanto en el chat como en tu sitio real
let firebaseConfig;
let appId = 'default-app-id';

try {
  if (typeof __firebase_config !== 'undefined') {
    firebaseConfig = JSON.parse(__firebase_config);
    if (typeof __app_id !== 'undefined') appId = __app_id;
  } else {
    firebaseConfig = MANUAL_CONFIG;
  }
} catch (e) {
  firebaseConfig = MANUAL_CONFIG;
}

// Inicializamos la conexi√≥n
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Nombre de la colecci√≥n de datos
const COLLECTION_NAME = (typeof __firebase_config !== 'undefined') 
  ? `artifacts/${appId}/public/data/elim_activities_v2` 
  : 'registros_elim'; 

// ------------------------------------------------------------------

const AUTHORIZED_DEACONS = ['moises', 'alvaro', 'renzo', 'rolando', 'william'];
const ADMIN_CREDENTIALS = { username: 'admin', password: 'Elim' };

const getCurrentMonth = () => {
  const date = new Date();
  return date.toLocaleString('es-NI', { month: 'long', year: 'numeric' });
};

export default function IglesiaElimApp() {
  const [firebaseUser, setFirebaseUser] = useState(null);
  const [appUser, setAppUser] = useState(null);
  const [role, setRole] = useState(null);
  
  const [loginUser, setLoginUser] = useState('');
  const [loginPass, setLoginPass] = useState('');
  const [showPasswordInput, setShowPasswordInput] = useState(false);
  const [error, setError] = useState('');

  const [view, setView] = useState('input');
  const [activities, setActivities] = useState([]);
  const [currentActivity, setCurrentActivity] = useState('');
  const [generatedReport, setGeneratedReport] = useState('');
  const [isReportDue, setIsReportDue] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // 1. Autenticaci√≥n Inteligente
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          // En Vercel usar√° esto. Aseg√∫rate de tener habilitado "Anonymous Auth" en Firebase Console
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Error de autenticaci√≥n:", err);
        if (err.code && err.code.includes('api-key')) {
            setError("Error: Falta poner la API KEY en el c√≥digo de GitHub (src/App.jsx).");
        } else {
            setError("Error conectando a la base de datos.");
        }
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setFirebaseUser(user);
    });
    return () => unsubscribe();
  }, []);

  // 2. Escuchar datos en tiempo real
  useEffect(() => {
    if (!firebaseConfig || (!firebaseConfig.apiKey && typeof __firebase_config === 'undefined')) return;
    
    // L√≥gica compatible para seleccionar la colecci√≥n correcta
    let activitiesRef;
    if (COLLECTION_NAME.includes('/')) {
        // Modo Chat (Ruta larga)
        // Nota t√©cnica: Firestore v9 modular prefiere no parsear slashes en collection()
        // Para compatibilidad simple, asumimos que si es chat usaremos la ruta expl√≠cita del entorno
        if (typeof __firebase_config !== 'undefined') {
             activitiesRef = collection(db, 'artifacts', appId, 'public', 'data', 'elim_activities_v2');
        } else {
             activitiesRef = collection(db, COLLECTION_NAME); 
        }
    } else {
        // Modo Vercel (Ruta corta 'registros_elim')
        activitiesRef = collection(db, COLLECTION_NAME);
    }

    const unsubscribe = onSnapshot(activitiesRef, (snapshot) => {
      const loadedActivities = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      loadedActivities.sort((a, b) => b.timestamp - a.timestamp);
      setActivities(loadedActivities);
      setIsLoading(false);
    }, (err) => {
      console.error("Error leyendo:", err);
      if (err.code === 'permission-denied') {
          setError("Error de permisos. Revisa las reglas de Firestore en la consola.");
      }
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const savedUser = localStorage.getItem('elim_user');
    const savedRole = localStorage.getItem('elim_role');
    if (savedUser && savedRole) {
      setAppUser(savedUser);
      setRole(savedRole);
      if (savedRole === 'admin') setView('report');
    }
    const now = new Date();
    if (now.getDate() === 1) setIsReportDue(true);
  }, []);

  // --- ACCIONES BD ---

  const addActivity = async () => {
    if (!currentActivity.trim()) return;
    try {
      const newActivity = {
        deacon: appUser,
        text: currentActivity,
        date: new Date().toLocaleDateString('es-NI'),
        month: getCurrentMonth(),
        timestamp: Date.now()
      };
      
      let targetCollection;
      if (typeof __firebase_config !== 'undefined') {
         targetCollection = collection(db, 'artifacts', appId, 'public', 'data', 'elim_activities_v2');
      } else {
         targetCollection = collection(db, COLLECTION_NAME);
      }
      
      await addDoc(targetCollection, newActivity);
      setCurrentActivity('');
    } catch (err) {
      console.error("Error guardando:", err);
      alert("Error al guardar. Verifica tu conexi√≥n.");
    }
  };

  const deleteActivity = async (id) => {
    try {
      let docRef;
      if (typeof __firebase_config !== 'undefined') {
         docRef = doc(db, 'artifacts', appId, 'public', 'data', 'elim_activities_v2', id);
      } else {
         docRef = doc(db, COLLECTION_NAME, id);
      }
      await deleteDoc(docRef);
    } catch (err) {
      console.error("Error borrando:", err);
    }
  };

  // --- LOGIN ---
  const handleLoginSubmit = (e) => {
    e.preventDefault();
    const cleanInput = loginUser.trim();
    if (cleanInput.toLowerCase() === ADMIN_CREDENTIALS.username) {
      if (!showPasswordInput) { setShowPasswordInput(true); setError(''); return; }
      if (loginPass === ADMIN_CREDENTIALS.password) {
        setAppUser('Administrador'); setRole('admin'); setView('report');
        localStorage.setItem('elim_user', 'Administrador'); localStorage.setItem('elim_role', 'admin');
        setError('');
      } else { setError('Contrase√±a incorrecta.'); }
      return;
    }
    const normalizedInput = cleanInput.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const normalizedAuth = AUTHORIZED_DEACONS.map(d => d.normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
    if (normalizedAuth.includes(normalizedInput)) {
      if (showPasswordInput) { setShowPasswordInput(false); setLoginPass(''); }
      const displayName = cleanInput.charAt(0).toUpperCase() + cleanInput.slice(1);
      setAppUser(displayName); setRole('deacon'); setView('input');
      localStorage.setItem('elim_user', displayName); localStorage.setItem('elim_role', 'deacon');
      setError('');
    } else { setError('Usuario no reconocido.'); }
  };

  const handleLogout = () => {
    setAppUser(null); setRole(null); setLoginUser(''); setLoginPass(''); setShowPasswordInput(false);
    localStorage.removeItem('elim_user'); localStorage.removeItem('elim_role');
  };

  const generateSmartReport = () => {
    const month = getCurrentMonth();
    if (activities.length === 0) { setGeneratedReport("No hay datos para generar informe."); return; }
    const currentMonthStr = getCurrentMonth();
    const relevantActivities = activities.filter(a => a.month === currentMonthStr);
    let report = `*INFORME MENSUAL - IGLESIA ELIM*\nüóìÔ∏è Mes: ${month.charAt(0).toUpperCase() + month.slice(1)}\n\n*RESUMEN DE LABORES:*\n`;
    relevantActivities.forEach(act => {
      let polishedText = act.text.trim();
      polishedText = polishedText.charAt(0).toUpperCase() + polishedText.slice(1);
      report += `‚Ä¢ ${polishedText}\n`;
    });
    setGeneratedReport(report);
  };

  const sendToWhatsApp = () => {
    if (!generatedReport) generateSmartReport();
    setTimeout(() => { window.open(`https://wa.me/?text=${encodeURIComponent(generatedReport || "Generando...")}`, '_blank'); }, 100);
  };

  if (!appUser) {
    return (
      <div className="min-h-screen bg-blue-900 flex items-center justify-center p-4 font-sans">
        <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
          <div className="text-center mb-8">
            <BookOpen className="w-12 h-12 text-blue-600 mx-auto mb-2" />
            <h1 className="text-2xl font-bold text-gray-800">Iglesia Elim</h1>
          </div>
          <form onSubmit={handleLoginSubmit} className="space-y-4">
            <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
               <input type="text" className="w-full p-3 border rounded-lg" placeholder="Nombre o admin" value={loginUser} onChange={e => setLoginUser(e.target.value)} />
            </div>
            {showPasswordInput && (
               <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                  <input type="password" className="w-full p-3 border rounded-lg" value={loginPass} onChange={e => setLoginPass(e.target.value)} />
               </div>
            )}
            {error && <p className="text-red-500 text-sm">{error}</p>}
            <button className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Ingresar</button>
          </form>
          <div className="mt-4 text-center">
            {firebaseUser ? <span className="text-green-600 text-xs flex justify-center items-center"><Wifi className="w-3 h-3 mr-1"/>BD Conectada</span> : <span className="text-gray-400 text-xs flex justify-center items-center"><Wifi className="w-3 h-3 mr-1 animate-pulse"/>Conectando...</span>}
            {!firebaseUser && MANUAL_CONFIG.apiKey.includes('TU_API_KEY') && typeof __firebase_config === 'undefined' && (
                <p className="text-amber-600 text-xs mt-2 font-bold bg-amber-50 p-2 rounded">
                  ‚ö†Ô∏è ATENCI√ìN: Debes poner tus llaves de Firebase en el archivo src/App.jsx en GitHub
                </p>
            )}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
      <header className="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
        <div className="flex items-center">
            <BookOpen className="text-blue-600 w-6 h-6 mr-2"/>
            <span className="font-bold text-gray-800">Iglesia Elim</span>
        </div>
        <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600 hidden sm:inline">{appUser}</span>
            <button onClick={handleLogout}><LogOut className="w-5 h-5 text-gray-500"/></button>
        </div>
      </header>
      <main className="flex-1 p-4 max-w-3xl mx-auto w-full">
        {role === 'admin' && (
            <div className="flex gap-2 mb-6 bg-white p-1 rounded-lg shadow-sm">
                <button onClick={() => setView('input')} className={`flex-1 py-2 text-sm font-bold rounded ${view === 'input' ? 'bg-blue-100 text-blue-700' : 'text-gray-500'}`}>Registros</button>
                <button onClick={() => { setView('report'); generateSmartReport(); }} className={`flex-1 py-2 text-sm font-bold rounded ${view === 'report' ? 'bg-amber-100 text-amber-700' : 'text-gray-500'}`}>Informe</button>
            </div>
        )}

        {view === 'input' ? (
            <div className="space-y-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 className="font-bold text-lg mb-4 flex items-center"><FileText className="w-5 h-5 mr-2 text-blue-500"/>Nueva Actividad</h2>
                    <textarea className="w-full p-4 border rounded-lg bg-gray-50 min-h-[100px]" placeholder="Describe la labor..." value={currentActivity} onChange={e => setCurrentActivity(e.target.value)} />
                    <button onClick={addActivity} className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg font-bold w-full sm:w-auto">Guardar</button>
                </div>
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 border-b bg-gray-50 font-bold text-gray-500 text-sm">HISTORIAL</div>
                    {isLoading ? <p className="p-8 text-center text-gray-400">Cargando...</p> : 
                     activities.length === 0 ? <p className="p-8 text-center text-gray-400">Sin registros</p> : 
                        activities.map(act => (
                            <div key={act.id} className="p-4 border-b last:border-0 flex justify-between">
                                <div>
                                    <span className="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded">{act.deacon}</span>
                                    <p className="mt-2 text-gray-800">{act.text}</p>
                                    <span className="text-xs text-gray-400">{act.date}</span>
                                </div>
                                {(role === 'admin' || act.deacon === appUser) && (
                                    <button onClick={() => deleteActivity(act.id)} className="text-gray-300 hover:text-red-500"><X className="w-4 h-4"/></button>
                                )}
                            </div>
                        ))
                    }
                </div>
            </div>
        ) : (
            <div className="bg-white p-6 rounded-xl shadow-lg border border-amber-200">
                {isReportDue && <div className="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm font-bold flex items-center"><Clock className="w-4 h-4 mr-2"/> ¬°Es hora de enviar el reporte!</div>}
                <h2 className="font-bold text-lg mb-4 flex items-center"><Sparkles className="w-5 h-5 mr-2 text-amber-500"/>Generador de Informe</h2>
                <textarea className="w-full h-64 p-4 border rounded-lg bg-gray-50 font-mono text-sm" value={generatedReport} onChange={e => setGeneratedReport(e.target.value)} />
                <div className="mt-4 flex gap-2 justify-end">
                    <button onClick={generateSmartReport} className="px-4 py-2 border rounded-lg font-bold text-gray-600">Regenerar</button>
                    <button onClick={sendToWhatsApp} className="px-6 py-2 bg-green-500 text-white rounded-lg font-bold flex items-center"><Send className="w-4 h-4 mr-2"/> WhatsApp</button>
                </div>
            </div>
        )}
      </main>
    </div>
  );
}
